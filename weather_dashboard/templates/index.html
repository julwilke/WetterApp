<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Dashboard - WetterApp</title>
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body id="page-top">
    <div id="wrapper" style="display:flex; align-items:stretch;">
        <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg p-0" style="width: 220px;">
            <div class="container-fluid d-flex flex-column p-0"><a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#">
                    <div class="sidebar-brand-icon rotate-n-15"><i class="fas fa-cloud-sun"></i></div>
                    <div class="sidebar-brand-text mx-3"><span>Wetter-App</span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item"><a class="nav-link active" href="/"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="/history"><i class="fas fa-table"></i><span>Verlauf</span></a></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper" style="flex:1 1 auto;">
            <div id="content" style="background-color: #070a12; min-height:100vh;">
                <nav class="navbar navbar-light navbar-expand bg-dark shadow mb-4 topbar static-top">
                    <div class="container-fluid" style="display:flex; gap:12px; align-items:center; background-color: #101d34;">
                        <button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggleTop" type="button"><i class="fas fa-bars"></i></button>
                        <form class="d-none d-sm-inline-block me-auto ms-md-3 my-2 my-md-0 mw-100 navbar-search" style="flex:1;">
                            <div class="input-group"><input id="cityInput" class="bg-light form-control border-0 small" type="text" placeholder="Suche nach Stadt..."><button id="cityButton" class="btn btn-primary py-0" type="button"><i class="fas fa-search"></i></button></div>
                        </form>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#" style="font-size: 2rem;"><i class="fab fa-cloudscale fa-fw"></i></a>
                                    <div class="dropdown-menu dropdown-menu-end bg-dark border-dark dropdown-list animated--grow-in">
                                        <h6 class="dropdown-header border-dark" style="background-color: rgb(25,29,33);">Api Status</h6>
                                        <div style="padding:10px; color:#cbd8e6;"><span>API:</span> <span id="apiStatus" class="offline">Offline</span></div>
                                    </div>
                                </div>
                            </li>
                            <li class="nav-item dropdown no-arrow"><a class="nav-link" href="https://github.com/julwilke/WetterApp" style="font-size: 2rem;" target="_blank"><i class="fab fa-github"></i></a></li>
                        </ul>
                    </div>
                </nav>

                <div class="container-fluid">
                    <div class="d-sm-flex justify-content-between align-items-center mb-4">
                        <h3 class="mb-0" id="cityDisplay">--</h3><a class="btn btn-primary btn-sm d-none d-sm-inline-block" role="button" href="#"><i class="fas fa-download fa-sm text-white-50"></i>&nbsp;Generate Report</a>
                    </div>

                    <div id="dashboard" class="row" style="display:grid; gap:20px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                        <!-- Cards are injected by JS into #dashboard - IDs must match existing script -->
                    </div>

                    <!-- additional layout sections could follow (charts etc.) -->
                </div>
            </div>
            <footer class="bg-white sticky-footer" style="background:transparent; border-top:1px solid rgba(255,255,255,0.03);">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span style="color:#cbd8e6;">Copyright © WetterApp 2025</span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top" style="display:none;"><i class="fas fa-angle-up"></i></a>
    </div>

    <!-- History Modal -->
    <div id="historyOverlay" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center;">
        <div id="historyModal" style="background:#071022; border:1px solid #1e2b3b; padding:18px; border-radius:8px; width: min(640px, 95%); color:#e6eef8; box-shadow:0 12px 30px rgba(0,0,0,0.6);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <strong id="historyTitle">Verlauf</strong>
                <button id="historyClose" style="background:transparent; border:none; color:#e6eef8; font-size:20px;">✕</button>
            </div>
            <div id="historyList" style="display:flex; flex-direction:row; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                <!-- filled dynamically -->
            </div>
        </div>
    </div>

    <!-- keep project scripts and the inline dashboard script intact -->
    <script src="/static/bootstrap/js/bootstrap.min.js"></script>
    <script src="/static/js/chart.min.js"></script>
    <script src="/static/js/bs-init.js"></script>
    <script src="/static/js/theme.js"></script>

    <script>
        // Original dashboard script preserved to keep all functions
        const socket = io();

        // Display order for cards
        const weatherVars = [
            "currentTemperature","feelsLike","tempMax","tempMin",
            "humidity","pressure","pressureTrend","windSpeed","windGust","windDirection",
            "weatherDescription","cloudCoverage","rain1h","rain3h","snow1h","snow3h",
            "visibility","uvIndex","sunrise","sunset","dewPoint",
            "airQualityIndex","pm2_5","pm10","co","no2","o3",
            "pollenCount","fog"
        ];

        const iconMap = {
            currentTemperature: 'fa-thermometer-half',
            feelsLike: 'fa-thermometer-half',
                tempMin: 'fa-thermometer-quarter',
                tempMax: 'fa-thermometer-full',
            humidity: 'fa-tint',
            sunset: 'fa-moon',
            visibility: 'fa-eye',
            dewPoint: 'fa-thermometer-quarter',
            airQualityIndex: 'fa-smog',
            pm10: 'fa-filter',
            pm2_5: 'fa-filter',
            co: 'fa-flask',
            no2: 'fa-flask',
            o3: 'fa-sun',
            pollenCount: 'fa-leaf',
            pressureTrend: 'fa-chart-line',
            fog: 'fa-water'
        };

        // Human readable labels and units
        const labelMap = {
            currentTemperature: 'Temperatur',
            feelsLike: 'Gefühlt',
            tempMin: 'Min Temp',
            tempMax: 'Max Temp',
            humidity: 'Luftfeuchte',
            pressure: 'Luftdruck',
            pressureTrend: 'Drucktrend',
            weatherDescription: 'Beschreibung',
            cloudCoverage: 'Bewölkung',
            rain1h: 'Regen (1h)',
            rain3h: 'Regen (3h)',
            snow1h: 'Schnee (1h)',
            snow3h: 'Schnee (3h)',
            windSpeed: 'Wind',
            windGust: 'Windböe',
            windDirection: 'Windrichtung',
            uvIndex: 'UV-Index',
            sunrise: 'Sonnenaufgang',
            sunset: 'Sonnenuntergang',
            visibility: 'Sichtweite',
            dewPoint: 'Taupunkt',
            airQualityIndex: 'Luftqualität',
            pm10: 'PM10',
            pm2_5: 'PM2.5',
            co: 'CO',
            no2: 'NO2',
            o3: 'O3',
            pollenCount: 'Pollen',
            fog: 'Nebel'
        };

        const unitMap = {
            currentTemperature: '°C',
            feelsLike: '°C',
            tempMin: '°C',
            tempMax: '°C',
            humidity: '%',
            pressure: 'hPa',
            pressureTrend: '',
            weatherDescription: '',
            cloudCoverage: '%',
            rain1h: 'mm',
            rain3h: 'mm',
            snow1h: 'mm',
            snow3h: 'mm',
            windSpeed: 'km/h',
            windGust: 'km/h',
            windDirection: '°',
            uvIndex: '',
            sunrise: '',
            sunset: '',
            visibility: 'm',
            dewPoint: '°C',
            airQualityIndex: 'AQI',
            pm10: 'µg/m³',
            pm2_5: 'µg/m³',
            co: 'ppm',
            no2: 'ppb',
            o3: 'ppb',
            pollenCount: '',
            fog: ''
        };

        // Color series for cards (bunt)
        const colors = [
            '#ff6b6b', // red
            '#ffd93d', // yellow
            '#6bcB77', // green
            '#6b8cff', // blue
            '#a368ff', // violet
            '#ff8b6b', // orange
            '#42d392', // mint
            '#7dd3fc', // cyan
            '#f0a6ff', // pink
            '#ff8bd1'  // rose
        ];

        // Erstelle Blöcke für alle Variablen
        const elements = {};
        const dashboard = document.getElementById('dashboard');
        weatherVars.forEach((v, idx) => {
            const block = document.createElement('div');
            block.className = "weather-block";
            block.style.setProperty('min-height', '160px');
            // assign a color from list
            const color = colors[idx % colors.length];
            block.style.setProperty('--title-bg', color);
            const iconClass = iconMap[v] || 'fa-square';
            const label = labelMap[v] || v;
            const unit = unitMap[v] || '';
            if (v === 'windDirection') {
                block.innerHTML = `
                    <i class="fas ${iconClass} big-icon"></i>
                    <div class="card-title">${label}</div>
                    <div class="compass" aria-hidden="true">
                        <svg class="compass-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="46" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="2"/>
                            <line x1="50" y1="6" x2="50" y2="18" stroke="rgba(255,255,255,0.1)" stroke-width="2"/>
                            <text x="50" y="20" text-anchor="middle" fill="rgba(255,255,255,0.5)" font-size="6">N</text>
                        </svg>
                        <div class="compass-arrow" id="arrow-${v}"></div>
                    </div>
                    <i class="fas fa-grip-lines drag-handle" draggable="true" title="Verschieben" aria-hidden="true"></i>
                    <div class="card-value"><span id="${v}" class="value">--</span><span class="unit">${unit}</span></div>
                `;
            } else {
                block.innerHTML = `
                    <i class="fas ${iconClass} big-icon"></i>
                    <div class="card-title">${label}</div>
                    <i class="fas fa-grip-lines drag-handle" draggable="true" title="Verschieben" aria-hidden="true"></i>
                    <div class="card-value"><span id="${v}" class="value">--</span><span class="unit">${unit}</span></div>
                `;
            }
            dashboard.appendChild(block);
            elements[v] = document.getElementById(v);

            const handle = block.querySelector('.drag-handle');
            block.dataset.var = v;
            block.addEventListener('click', (e) => {
                if (e.target.classList.contains('drag-handle')) return;
                openHistory(v);
            });
            handle.addEventListener('dragstart', (e) => {
                draggedItem = block;
                block.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                try { e.dataTransfer.setData('text/plain', ''); } catch (err) {}
            });
            handle.addEventListener('dragend', (e) => {
                draggedItem = null;
                block.classList.remove('dragging');
            });
        });

        // DnD reordering
        let draggedItem = null;
        const grid = dashboard;
        grid.addEventListener('dragover', (e) => {
            e.preventDefault();
            const target = e.target.closest('.weather-block');
            if (!target || target === draggedItem) return;
            const rect = target.getBoundingClientRect();
            const offset = (e.clientX - rect.left) / rect.width;
            if (offset > 0.5) {
                if (target.nextSibling !== draggedItem) grid.insertBefore(draggedItem, target.nextSibling);
            } else {
                if (target !== draggedItem.nextSibling) grid.insertBefore(draggedItem, target);
            }
        });

        // HISTORY MODAL functions
        const historyOverlay = document.getElementById('historyOverlay');
        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const historyTitle = document.getElementById('historyTitle');
        const historyClose = document.getElementById('historyClose');

        function openHistory(variable) {
            const label = labelMap[variable] || variable;
            historyTitle.innerText = `${label} Verlauf`;
            historyList.innerHTML = '';
            const currentStr = (elements[variable] && elements[variable].innerText) ? elements[variable].innerText : '--';
            const unit = unitMap[variable] || '';
            let currentVal = parseFloat(currentStr);
            const deltaMap = { currentTemperature: 0.6, feelsLike: 0.6, tempMin:0.4, tempMax:0.4, humidity:1, windSpeed:1.2, visibility:100 };
            const step = deltaMap[variable] || 1;
            for (let hr = -4; hr <= 4; hr++) {
                const valStr = (!isNaN(currentVal)) ? (currentVal + hr * step).toFixed(1) : currentStr;
                const item = document.createElement('div');
                item.style = 'background:#071022; border:1px solid #1e2b3b; padding:8px; border-radius:6px; min-width:48px; text-align:center;';
                item.innerHTML = `<div style="font-size:12px; opacity:0.6;">${hr}h</div><div style="font-size:20px; font-weight:700;">${valStr}${unit}</div>`;
                historyList.appendChild(item);
            }
            historyOverlay.style.display = 'flex';
        }
        function closeHistory() { historyOverlay.style.display = 'none'; }
        historyClose.addEventListener('click', closeHistory);
        historyOverlay.addEventListener('click', (e)=> { if (e.target === historyOverlay) closeHistory(); });

        // Updates vom Server empfangen
        socket.on('update', data => {
            for (let key in data) {
                if (key === 'city') {
                    const cityDisplay = document.getElementById('cityDisplay');
                    if (cityDisplay) cityDisplay.innerText = data.city;
                }
                if (elements[key]) elements[key].innerText = data[key];
                if (key === 'windDirection') {
                    const arrow = document.getElementById('arrow-windDirection');
                    const deg = parseFloat(data[key]);
                    if (!isNaN(deg) && arrow) arrow.style.transform = `translate(-50%, -100%) rotate(${deg}deg)`;
                }
            }
        });

        // Initiale Daten vom Server holen
        fetch('/weather')
            .then(res => res.json())
            .then(data => {
                for (let key in data) {
                    if (key === 'city') {
                        const cityDisplay = document.getElementById('cityDisplay');
                        if (cityDisplay) cityDisplay.innerText = data.city;
                    }
                    if (elements[key]) elements[key].innerText = data[key];
                    if (key === 'windDirection') {
                        const arrow = document.getElementById('arrow-windDirection');
                        const deg = parseFloat(data[key]);
                        if (!isNaN(deg) && arrow) arrow.style.transform = `translate(-50%, -100%) rotate(${deg}deg)`;
                    }
                }
            });

        // Stadt an Backend senden
        const cityInput = document.getElementById('cityInput');
        const cityButton = document.getElementById('cityButton');

        cityButton.addEventListener('click', () => {
            const city = cityInput.value.trim();
            if (city !== "") {
                socket.emit('cityInput', { city: city });
                cityInput.value = "";
            }
        });

        cityInput.addEventListener('keydown', (e) => {
            if (e.key === "Enter") {
                cityButton.click();
            }
        });

        // Menu logic (small)
        async function updateApiStatus() {
            try {
                const res = await fetch('/status');
                const apiStatus = document.getElementById('apiStatus');
                if (res.ok) {
                    apiStatus.innerText = 'Online';
                    apiStatus.classList.remove('offline');
                    apiStatus.classList.add('online');
                } else {
                    apiStatus.innerText = 'Fehler';
                    apiStatus.classList.remove('online');
                    apiStatus.classList.add('offline');
                }
            } catch (err) {
                const apiStatus = document.getElementById('apiStatus');
                apiStatus.innerText = 'Offline';
                apiStatus.classList.remove('online');
                apiStatus.classList.add('offline');
            }
        }
        updateApiStatus();
        setInterval(updateApiStatus, 15000);
    </script>
</body>

</html>
